---
title: 分块缓冲
description: 可视化 WSOLA 拉伸引擎的分块缓冲行为
---

import ChunkBufferingDemo from '../../../../components/demo/ChunkBufferingDemo.astro';

用于观察 WSOLA 拉伸引擎分块缓冲机制的演示。

- **分块条**: 实时显示每个分块的处理状态（pending → queued → converting → ready）
- **图例**: 查看每种颜色的含义
- **事件日志**: 实时记录缓冲开始/结束、分块转换和缓冲健康度变化
- **节奏滑块**: 观察改变节奏时的分块重新调度
- **定位**: 点击波形查看从新位置加载分块

<ChunkBufferingDemo locale="zh-cn" />

## 代码示例

### 获取拉伸器快照

```ts
import { WaaPlayer } from "waa-play";

const player = new WaaPlayer();
const buffer = await player.load("/music.mp3");

const playback = player.play(buffer, {
  playbackRate: 1.0,
  preservePitch: true,
});

const stop = player.onFrame(playback, (snapshot) => {
  const { stretcher } = snapshot;
  if (stretcher) {
    console.log(`Chunk states: ${stretcher.chunkStates.join(", ")}`);
    console.log(`Current chunk: #${stretcher.currentChunkIndex}`);
    console.log(`Buffer health: ${stretcher.bufferHealth}`);
    console.log(`Buffering: ${stretcher.buffering}`);
    console.log(`Ahead: ${stretcher.aheadSeconds.toFixed(1)}s`);
  }
});
```
