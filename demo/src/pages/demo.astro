---
import StarlightPage from '@astrojs/starlight/components/StarlightPage.astro';

const basicCode = `import { WaaPlayer } from "waa-play";

// Create player (manages AudioContext internally)
const player = new WaaPlayer();
const buffer = player.createSineBuffer(440, 2);

// Build audio graph
const gain = player.createGain(0.8);
const panner = player.createPanner(0);

// Start playback
const playback = player.play(buffer, {
  through: [gain, panner],
  loop: true,
});

// Extract waveform data for visualization
const peaks = player.extractPeakPairs(buffer, { resolution: 300 });

// Subscribe to time updates
playback.on("timeupdate", ({ position, duration }) =&gt; {
  console.log(\`\${position.toFixed(1)}s / \${duration.toFixed(1)}s\`);
});

// Controls
playback.pause();
playback.resume();
playback.seek(1.0);
playback.setPlaybackRate(1.5);
playback.stop();

// Cleanup
player.dispose();`;

const byoCode = `import { WaaPlayer } from "waa-play";

// Bring your own AudioContext
const ctx = new AudioContext({ sampleRate: 48000 });
const player = new WaaPlayer(ctx);

// Load once, play many times
const buffer = await player.load("/drums.mp3");

const gain = player.createGain(0.8);
const comp = player.createCompressor({ ratio: 4 });

const a = player.play(buffer, { through: [gain, comp] });

a.on("ended", () =&gt; {
  // Reuse the same buffer
  player.play(buffer, { through: [gain, comp] });
});

// player.dispose() won't close ctx (not owned)
player.dispose();
ctx.close();`;

const reactCode = `import { useSyncExternalStore, useEffect, useRef } from "react";
import { WaaPlayer, getSnapshot, subscribeSnapshot, onFrame } from "waa-play";
import type { Playback, PlaybackSnapshot, PeakPair } from "waa-play";

const player = new WaaPlayer();

function usePlaybackSnapshot(playback: Playback | null): PlaybackSnapshot | null {
  return useSyncExternalStore(
    (cb) =&gt; (playback ? subscribeSnapshot(playback, cb) : () =&gt; {}),
    () =&gt; (playback ? getSnapshot(playback) : null),
  );
}

function Player({ buffer }: { buffer: AudioBuffer }) {
  const [playback, setPlayback] = useState&lt;Playback | null&gt;(null);
  const snap = usePlaybackSnapshot(playback);
  const peaks = useMemo(() =&gt; player.extractPeakPairs(buffer, { resolution: 200 }), [buffer]);

  return (
    &lt;div&gt;
      &lt;Waveform peaks={peaks} progress={snap?.progress ?? 0} /&gt;
      &lt;button onClick={() =&gt; {
        if (!playback) setPlayback(player.play(buffer));
        else playback.togglePlayPause();
      }}&gt;
        {snap?.state === "playing" ? "Pause" : "Play"}
      &lt;/button&gt;
      &lt;span&gt;{snap?.position.toFixed(1)}s / {snap?.duration.toFixed(1)}s&lt;/span&gt;
    &lt;/div&gt;
  );
}`;
---

<StarlightPage frontmatter={{ title: 'Live Demo', template: 'splash' }}>
  <div class="demo-wrapper">
    <div class="demo-header">
      <h2>waa</h2>
      <p class="subtitle">Composable & batteries-included Web Audio API toolkit</p>
    </div>

    <main>
      <!-- Sound Source Section -->
      <section class="card">
        <h2>Sound Source</h2>
        <p class="description">Generate a synthesized tone or load an audio file to get started.</p>
        <div class="source-controls">
          <div class="synth-controls">
            <div class="synth-params">
              <label class="synth-label">
                <span class="label-text">Type</span>
                <select id="synth-type">
                  <option value="sine">Sine Wave</option>
                  <option value="noise">White Noise</option>
                  <option value="click">Click / Impulse</option>
                </select>
              </label>
              <label class="synth-label">
                <span class="label-text">Frequency</span>
                <input type="range" id="synth-freq" min="50" max="2000" value="440" />
                <span id="synth-freq-val" class="range-value">440 Hz</span>
              </label>
              <label class="synth-label">
                <span class="label-text">Duration</span>
                <input type="range" id="synth-dur" min="0.5" max="5" step="0.5" value="2" />
                <span id="synth-dur-val" class="range-value">2.0 s</span>
              </label>
            </div>
            <button id="btn-generate" class="btn btn-primary">Generate</button>
          </div>
          <div class="divider">or</div>
          <div class="file-controls">
            <label class="btn btn-secondary file-label" id="file-label">
              <svg class="file-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              <span id="file-label-text">Load Audio File</span>
              <input type="file" id="file-input" accept="audio/*" hidden />
            </label>
            <span id="file-name" class="file-name"></span>
          </div>
        </div>
      </section>

      <!-- Waveform Section -->
      <section class="card" id="waveform-section" hidden>
        <h2>Waveform</h2>
        <div class="waveform-container">
          <div id="waveform-buffer-bar" class="waveform-buffer-bar"></div>
          <canvas id="waveform-canvas"></canvas>
          <div id="waveform-cursor" class="waveform-cursor"></div>
        </div>
        <div id="chunk-strip" class="chunk-strip" hidden>
          <div id="chunk-strip-blocks" class="chunk-strip-blocks"></div>
        </div>
        <div id="time-display" class="time-display">
          <span id="time-current">0:00.0</span>
          <span id="time-duration">0:00.0</span>
        </div>
      </section>

      <!-- Playback Controls -->
      <section class="card" id="playback-section" hidden>
        <h2>Playback</h2>
        <div class="playback-controls">
          <div class="transport-buttons">
            <button id="btn-play-pause" class="btn btn-icon btn-transport" title="Play" data-state="stopped">
              <svg class="icon-play" viewBox="0 0 24 24" width="20" height="20"><polygon points="6,3 20,12 6,21" fill="currentColor"/></svg>
              <svg class="icon-pause" viewBox="0 0 24 24" width="20" height="20" hidden><rect x="5" y="3" width="4" height="18" fill="currentColor"/><rect x="15" y="3" width="4" height="18" fill="currentColor"/></svg>
            </button>
            <button id="btn-stop" class="btn btn-icon btn-transport" title="Stop" disabled>
              <svg viewBox="0 0 24 24" width="18" height="18"><rect x="4" y="4" width="16" height="16" rx="2" fill="currentColor"/></svg>
            </button>
          </div>
          <div class="control-params">
            <label class="control-label">
              Volume
              <input type="range" id="volume" min="0" max="1" step="0.01" value="0.8" />
            </label>
            <label class="control-label">
              Pan
              <input type="range" id="pan" min="-1" max="1" step="0.01" value="0" />
            </label>
            <label class="control-label">
              Speed
              <select id="speed">
                <option value="0.5">0.5x</option>
                <option value="0.75">0.75x</option>
                <option value="1" selected>1x</option>
                <option value="1.25">1.25x</option>
                <option value="1.5">1.5x</option>
                <option value="2">2x</option>
              </select>
            </label>
            <label class="control-label control-label-checkbox">
              <input type="checkbox" id="loop" />
              Loop
            </label>
            <label class="control-label control-label-checkbox">
              <input type="checkbox" id="preserve-pitch" checked />
              Preserve Pitch
            </label>
          </div>
        </div>

        <!-- Stretcher Status -->
        <div id="stretcher-status" class="stretcher-status" hidden>
          <div class="stretcher-status-header">
            <span class="stretcher-status-title">Stretcher Engine</span>
            <span id="stretcher-buffering" class="stretcher-buffering" hidden>
              <span class="spinner spinner-sm"></span>
              Buffering...
            </span>
          </div>
          <div class="stretcher-progress">
            <div id="stretcher-progress-fill" class="stretcher-progress-fill" style="width: 0%"></div>
          </div>
          <div class="stretcher-info">
            <span id="buffer-health" class="buffer-health buffer-empty"></span>
            <span id="stretcher-detail" class="stretcher-detail"></span>
          </div>
        </div>
      </section>

      <!-- Frequency Visualizer -->
      <section class="card" id="visualizer-section" hidden>
        <h2>Frequency Visualizer</h2>
        <canvas id="visualizer-canvas"></canvas>
      </section>

      <!-- API Examples -->
      <section class="card">
        <h2>Code Examples</h2>
        <div class="code-tabs">
          <div class="code-tab-buttons">
            <button class="code-tab-btn active" data-tab="basic">Basic</button>
            <button class="code-tab-btn" data-tab="byo-context">BYO Context</button>
            <button class="code-tab-btn" data-tab="react">React</button>
          </div>
          <div class="code-tab-panel active" data-tab="basic">
            <pre><code set:html={basicCode} /></pre>
          </div>
          <div class="code-tab-panel" data-tab="byo-context">
            <pre><code set:html={byoCode} /></pre>
          </div>
          <div class="code-tab-panel" data-tab="react">
            <pre><code set:html={reactCode} /></pre>
          </div>
        </div>
      </section>
    </main>

    <div class="demo-footer">
      <p>
        <a href="https://github.com/ivgtr/waa" target="_blank" rel="noopener">GitHub</a>
        &middot; Zero dependencies &middot; Framework-agnostic &middot; Sample-accurate
      </p>
    </div>
  </div>
</StarlightPage>

<script>
  import { initDemo } from '../demo/main';
  initDemo();
</script>

<style>
  @import '../demo/style.css';
</style>
