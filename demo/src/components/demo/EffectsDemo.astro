---
import { t } from '../../i18n/translations';
import type { Locale } from '../../i18n/translations';
import SoundSourceCard from './SoundSourceCard.astro';
import TransportButtons from './TransportButtons.astro';

interface Props {
  locale: Locale;
}

const { locale } = Astro.props;
---

<div
  class="demo-wrapper not-content"
  id="effects-demo"
  data-i18n-pause={t(locale, 'playback.pause')}
  data-i18n-play={t(locale, 'playback.play')}
  data-i18n-loading={t(locale, 'source.loading')}
  data-i18n-load-failed={t(locale, 'source.load-failed')}
  data-i18n-load-file={t(locale, 'source.load-file')}
>
  <SoundSourceCard locale={locale} prefix="fx-" durMin={1} durDefault={3} />

  <!-- Effects Chain -->
  <section class="card" id="fx-controls-section" hidden>
    <h2>{t(locale, 'demo.effects.title')}</h2>
    <div class="control-params" style="flex-direction: column; gap: 0.75rem;">
      <label class="control-label">
        {t(locale, 'demo.effects.gain')}
        <input type="range" id="fx-gain" min="0" max="2" step="0.01" value="0.8" />
        <span id="fx-gain-val" class="range-value">0.80</span>
      </label>
      <label class="control-label">
        {t(locale, 'demo.effects.filter-type')}
        <select id="fx-filter-type">
          <option value="lowpass">{t(locale, 'demo.effects.filter-lowpass')}</option>
          <option value="highpass">{t(locale, 'demo.effects.filter-highpass')}</option>
          <option value="bandpass">{t(locale, 'demo.effects.filter-bandpass')}</option>
        </select>
      </label>
      <label class="control-label">
        {t(locale, 'demo.effects.filter-freq')}
        <input type="range" id="fx-filter-freq" min="20" max="20000" step="1" value="1000" />
        <span id="fx-filter-freq-val" class="range-value">1000 Hz</span>
      </label>
      <label class="control-label">
        {t(locale, 'demo.effects.filter-q')}
        <input type="range" id="fx-filter-q" min="0.1" max="20" step="0.1" value="1" />
        <span id="fx-filter-q-val" class="range-value">1.0</span>
      </label>
    </div>

    <div style="margin-top: 1rem;">
      <TransportButtons locale={locale} prefix="fx-" />
    </div>
  </section>

  <!-- Fade Controls -->
  <section class="card" id="fx-fade-section" hidden>
    <h2>{t(locale, 'demo.effects.fade')}</h2>
    <div class="control-params" style="flex-direction: column; gap: 0.75rem;">
      <label class="control-label">
        {t(locale, 'demo.effects.fade-duration')}
        <input type="range" id="fx-fade-dur" min="0.1" max="3" step="0.1" value="0.5" />
        <span id="fx-fade-dur-val" class="range-value">0.5 s</span>
      </label>
      <div style="display: flex; gap: 0.5rem;">
        <button id="fx-btn-fade-in" class="btn">{t(locale, 'demo.effects.fade-in')}</button>
        <button id="fx-btn-fade-out" class="btn">{t(locale, 'demo.effects.fade-out')}</button>
      </div>
    </div>
  </section>
</div>

<script>
  import { createDemoController } from '../../demo/demo-controller';
  import { $ } from '../../demo/demo-utils';

  let gainNode: GainNode | null = null;
  let filterNode: BiquadFilterNode | null = null;

  const gainInput = $<HTMLInputElement>('fx-gain');
  const gainVal = $('fx-gain-val');
  const filterType = $<HTMLSelectElement>('fx-filter-type');
  const filterFreq = $<HTMLInputElement>('fx-filter-freq');
  const filterFreqVal = $('fx-filter-freq-val');
  const filterQ = $<HTMLInputElement>('fx-filter-q');
  const filterQVal = $('fx-filter-q-val');
  const fadeDur = $<HTMLInputElement>('fx-fade-dur');
  const fadeDurVal = $('fx-fade-dur-val');
  const btnFadeIn = $<HTMLButtonElement>('fx-btn-fade-in');
  const btnFadeOut = $<HTMLButtonElement>('fx-btn-fade-out');

  const ctrl = createDemoController({
    wrapperId: 'effects-demo',
    prefix: 'fx-',
    waveform: false,
    initNodes(player) {
      gainNode = player.createGain(Number(gainInput.value));
      filterNode = player.ctx.createBiquadFilter();
      filterNode.type = filterType.value as BiquadFilterType;
      filterNode.frequency.value = Number(filterFreq.value);
      filterNode.Q.value = Number(filterQ.value);
      player.chain(gainNode, filterNode, player.ctx.destination);
      return gainNode;
    },
    onBufferLoaded() {
      $('fx-controls-section').hidden = false;
      $('fx-fade-section').hidden = false;
    },
    getPlayOptions() {
      return { loop: true };
    },
  });

  gainInput.addEventListener('input', () => {
    const v = Number(gainInput.value);
    gainVal.textContent = v.toFixed(2);
    if (gainNode) gainNode.gain.value = v;
  });

  filterType.addEventListener('change', () => {
    if (filterNode) filterNode.type = filterType.value as BiquadFilterType;
  });

  filterFreq.addEventListener('input', () => {
    const v = Number(filterFreq.value);
    filterFreqVal.textContent = `${v} Hz`;
    if (filterNode) filterNode.frequency.value = v;
  });

  filterQ.addEventListener('input', () => {
    const v = Number(filterQ.value);
    filterQVal.textContent = v.toFixed(1);
    if (filterNode) filterNode.Q.value = v;
  });

  fadeDur.addEventListener('input', () => {
    fadeDurVal.textContent = `${Number(fadeDur.value).toFixed(1)} s`;
  });

  btnFadeIn.addEventListener('click', () => {
    if (!gainNode) return;
    ctrl.player.fadeIn(gainNode, Number(fadeDur.value));
  });

  btnFadeOut.addEventListener('click', () => {
    if (!gainNode) return;
    ctrl.player.fadeOut(gainNode, Number(fadeDur.value));
  });
</script>

<style is:global>
  @import '../../demo/style.css';
</style>
