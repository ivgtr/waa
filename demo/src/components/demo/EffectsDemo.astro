---
import { t } from '../../i18n/translations';
import type { Locale } from '../../i18n/translations';

interface Props {
  locale: Locale;
}

const { locale } = Astro.props;
---

<div
  class="demo-wrapper not-content"
  id="effects-demo"
  data-i18n-pause={t(locale, 'playback.pause')}
  data-i18n-play={t(locale, 'playback.play')}
>
  <!-- Sound Source -->
  <section class="card">
    <h2>{t(locale, 'source.title')}</h2>
    <div class="source-controls">
      <div class="synth-controls">
        <div class="synth-params">
          <label class="synth-label">
            <span class="label-text">{t(locale, 'source.type')}</span>
            <select id="fx-synth-type">
              <option value="sine">{t(locale, 'source.sine')}</option>
              <option value="noise">{t(locale, 'source.noise')}</option>
            </select>
          </label>
          <label class="synth-label">
            <span class="label-text">{t(locale, 'source.duration')}</span>
            <input type="range" id="fx-synth-dur" min="1" max="5" step="0.5" value="3" />
            <span id="fx-synth-dur-val" class="range-value">3.0 s</span>
          </label>
        </div>
        <button id="fx-btn-generate" class="btn btn-primary">{t(locale, 'source.generate')}</button>
      </div>
    </div>
  </section>

  <!-- Effects Chain -->
  <section class="card" id="fx-controls-section" hidden>
    <h2>{t(locale, 'demo.effects.title')}</h2>
    <div class="control-params" style="flex-direction: column; gap: 0.75rem;">
      <label class="control-label">
        {t(locale, 'demo.effects.gain')}
        <input type="range" id="fx-gain" min="0" max="2" step="0.01" value="0.8" />
        <span id="fx-gain-val" class="range-value">0.80</span>
      </label>
      <label class="control-label">
        {t(locale, 'demo.effects.filter-type')}
        <select id="fx-filter-type">
          <option value="lowpass">Lowpass</option>
          <option value="highpass">Highpass</option>
          <option value="bandpass">Bandpass</option>
        </select>
      </label>
      <label class="control-label">
        {t(locale, 'demo.effects.filter-freq')}
        <input type="range" id="fx-filter-freq" min="20" max="20000" step="1" value="1000" />
        <span id="fx-filter-freq-val" class="range-value">1000 Hz</span>
      </label>
      <label class="control-label">
        {t(locale, 'demo.effects.filter-q')}
        <input type="range" id="fx-filter-q" min="0.1" max="20" step="0.1" value="1" />
        <span id="fx-filter-q-val" class="range-value">1.0</span>
      </label>
    </div>

    <div class="transport-buttons" style="margin-top: 1rem;">
      <button id="fx-btn-play" class="btn btn-icon btn-transport" data-state="stopped">
        <svg class="icon-play" viewBox="0 0 24 24" width="20" height="20"><polygon points="6,3 20,12 6,21" fill="currentColor"/></svg>
        <svg class="icon-pause" viewBox="0 0 24 24" width="20" height="20" hidden><rect x="5" y="3" width="4" height="18" fill="currentColor"/><rect x="15" y="3" width="4" height="18" fill="currentColor"/></svg>
      </button>
      <button id="fx-btn-stop" class="btn btn-icon btn-transport" disabled>
        <svg viewBox="0 0 24 24" width="18" height="18"><rect x="4" y="4" width="16" height="16" rx="2" fill="currentColor"/></svg>
      </button>
    </div>
  </section>

  <!-- Fade Controls -->
  <section class="card" id="fx-fade-section" hidden>
    <h2>{t(locale, 'demo.effects.fade')}</h2>
    <div class="control-params" style="flex-direction: column; gap: 0.75rem;">
      <label class="control-label">
        {t(locale, 'demo.effects.fade-duration')}
        <input type="range" id="fx-fade-dur" min="0.1" max="3" step="0.1" value="0.5" />
        <span id="fx-fade-dur-val" class="range-value">0.5 s</span>
      </label>
      <div style="display: flex; gap: 0.5rem;">
        <button id="fx-btn-fade-in" class="btn">Fade In</button>
        <button id="fx-btn-fade-out" class="btn">Fade Out</button>
      </div>
    </div>
  </section>
</div>

<script>
  import { getSharedPlayer } from '../../demo/shared-player';
  import type { Playback } from 'waa';

  const $ = <T extends HTMLElement>(id: string) => document.getElementById(id) as T;

  const wrapper = document.getElementById('effects-demo') as HTMLElement;
  const i18n = {
    pause: wrapper?.dataset.i18nPause ?? 'Pause',
    play: wrapper?.dataset.i18nPlay ?? 'Play',
  };

  const synthType = $<HTMLSelectElement>('fx-synth-type');
  const synthDur = $<HTMLInputElement>('fx-synth-dur');
  const synthDurVal = $('fx-synth-dur-val');
  const btnGenerate = $<HTMLButtonElement>('fx-btn-generate');

  const controlsSection = $('fx-controls-section');
  const fadeSection = $('fx-fade-section');

  const gainInput = $<HTMLInputElement>('fx-gain');
  const gainVal = $('fx-gain-val');
  const filterType = $<HTMLSelectElement>('fx-filter-type');
  const filterFreq = $<HTMLInputElement>('fx-filter-freq');
  const filterFreqVal = $('fx-filter-freq-val');
  const filterQ = $<HTMLInputElement>('fx-filter-q');
  const filterQVal = $('fx-filter-q-val');

  const btnPlay = $<HTMLButtonElement>('fx-btn-play');
  const btnStop = $<HTMLButtonElement>('fx-btn-stop');
  const iconPlay = btnPlay.querySelector('.icon-play') as SVGElement;
  const iconPause = btnPlay.querySelector('.icon-pause') as SVGElement;

  const fadeDur = $<HTMLInputElement>('fx-fade-dur');
  const fadeDurVal = $('fx-fade-dur-val');
  const btnFadeIn = $<HTMLButtonElement>('fx-btn-fade-in');
  const btnFadeOut = $<HTMLButtonElement>('fx-btn-fade-out');

  const player = getSharedPlayer();
  let gainNode: GainNode | null = null;
  let filterNode: BiquadFilterNode | null = null;
  let currentBuffer: AudioBuffer | null = null;
  let currentPlayback: Playback | null = null;

  function initNodes() {
    if (!gainNode) {
      gainNode = player.createGain(Number(gainInput.value));
      filterNode = player.ctx.createBiquadFilter();
      filterNode.type = filterType.value as BiquadFilterType;
      filterNode.frequency.value = Number(filterFreq.value);
      filterNode.Q.value = Number(filterQ.value);
      player.chain(gainNode, filterNode, player.ctx.destination);
    }
  }

  function setTransportState(state: 'stopped' | 'playing' | 'paused') {
    btnPlay.dataset.state = state;
    if (state === 'playing') {
      iconPlay.setAttribute('hidden', '');
      iconPause.removeAttribute('hidden');
      btnStop.disabled = false;
    } else {
      iconPause.setAttribute('hidden', '');
      iconPlay.removeAttribute('hidden');
      btnStop.disabled = state === 'stopped';
    }
  }

  synthDur.addEventListener('input', () => {
    synthDurVal.textContent = `${Number(synthDur.value).toFixed(1)} s`;
  });

  gainInput.addEventListener('input', () => {
    const v = Number(gainInput.value);
    gainVal.textContent = v.toFixed(2);
    if (gainNode) gainNode.gain.value = v;
  });

  filterType.addEventListener('change', () => {
    if (filterNode) filterNode.type = filterType.value as BiquadFilterType;
  });

  filterFreq.addEventListener('input', () => {
    const v = Number(filterFreq.value);
    filterFreqVal.textContent = `${v} Hz`;
    if (filterNode) filterNode.frequency.value = v;
  });

  filterQ.addEventListener('input', () => {
    const v = Number(filterQ.value);
    filterQVal.textContent = v.toFixed(1);
    if (filterNode) filterNode.Q.value = v;
  });

  fadeDur.addEventListener('input', () => {
    fadeDurVal.textContent = `${Number(fadeDur.value).toFixed(1)} s`;
  });

  btnGenerate.addEventListener('click', async () => {
    await player.ensureRunning();
    initNodes();
    const dur = Number(synthDur.value);
    const type = synthType.value;
    currentBuffer = type === 'noise'
      ? player.createNoiseBuffer(dur)
      : player.createSineBuffer(440, dur);
    controlsSection.hidden = false;
    fadeSection.hidden = false;
    setTransportState('stopped');
  });

  btnPlay.addEventListener('click', async () => {
    await player.ensureRunning();
    initNodes();
    if (!currentBuffer) return;
    if (currentPlayback && currentPlayback.getState() === 'playing') {
      currentPlayback.pause();
      setTransportState('paused');
      return;
    }
    if (currentPlayback && currentPlayback.getState() === 'paused') {
      currentPlayback.resume();
      setTransportState('playing');
      return;
    }
    if (currentPlayback) currentPlayback.dispose();
    currentPlayback = player.play(currentBuffer, {
      through: [gainNode!],
      loop: true,
    });
    setTransportState('playing');
    currentPlayback.on('ended', () => setTransportState('stopped'));
  });

  btnStop.addEventListener('click', () => {
    if (currentPlayback) {
      currentPlayback.stop();
      setTransportState('stopped');
    }
  });

  btnFadeIn.addEventListener('click', () => {
    if (!gainNode) return;
    const dur = Number(fadeDur.value);
    player.fadeIn(gainNode, dur);
  });

  btnFadeOut.addEventListener('click', () => {
    if (!gainNode) return;
    const dur = Number(fadeDur.value);
    player.fadeOut(gainNode, dur);
  });
</script>

<style>
  @import '../../demo/style.css';
</style>
