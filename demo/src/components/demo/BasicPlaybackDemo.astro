---
import { t } from '../../i18n/translations';
import type { Locale } from '../../i18n/translations';

interface Props {
  locale: Locale;
}

const { locale } = Astro.props;
---

<div
  class="demo-wrapper not-content"
  data-i18n-pause={t(locale, 'playback.pause')}
  data-i18n-play={t(locale, 'playback.play')}
  data-i18n-loading={t(locale, 'source.loading')}
  data-i18n-load-failed={t(locale, 'source.load-failed')}
  data-i18n-load-file={t(locale, 'source.load-file')}
>
  <!-- Sound Source Section -->
  <section class="card">
    <h2>{t(locale, 'source.title')}</h2>
    <p class="description">{t(locale, 'source.description')}</p>
    <div class="source-controls">
      <div class="synth-controls">
        <div class="synth-params">
          <label class="synth-label">
            <span class="label-text">{t(locale, 'source.type')}</span>
            <select id="synth-type">
              <option value="sine">{t(locale, 'source.sine')}</option>
              <option value="noise">{t(locale, 'source.noise')}</option>
              <option value="click">{t(locale, 'source.click')}</option>
            </select>
          </label>
          <label class="synth-label">
            <span class="label-text">{t(locale, 'source.frequency')}</span>
            <input type="range" id="synth-freq" min="50" max="2000" value="440" />
            <span id="synth-freq-val" class="range-value">440 Hz</span>
          </label>
          <label class="synth-label">
            <span class="label-text">{t(locale, 'source.duration')}</span>
            <input type="range" id="synth-dur" min="0.5" max="5" step="0.5" value="2" />
            <span id="synth-dur-val" class="range-value">2.0 s</span>
          </label>
        </div>
        <button id="btn-generate" class="btn btn-primary">{t(locale, 'source.generate')}</button>
      </div>
      <div class="divider">{t(locale, 'source.or')}</div>
      <div class="file-controls">
        <label class="btn btn-secondary file-label" id="file-label">
          <svg class="file-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          <span id="file-label-text">{t(locale, 'source.load-file')}</span>
          <input type="file" id="file-input" accept="audio/*" hidden />
        </label>
        <span id="file-name" class="file-name"></span>
      </div>
    </div>
  </section>

  <!-- Waveform Section -->
  <section class="card" id="waveform-section" hidden>
    <h2>{t(locale, 'waveform.title')}</h2>
    <div class="waveform-container">
      <canvas id="waveform-canvas"></canvas>
      <div id="waveform-cursor" class="waveform-cursor"></div>
    </div>
    <div id="time-display" class="time-display">
      <span id="time-current">0:00.0</span>
      <span id="time-duration">0:00.0</span>
    </div>
  </section>

  <!-- Playback Controls -->
  <section class="card" id="playback-section" hidden>
    <h2>{t(locale, 'playback.title')}</h2>
    <div class="playback-controls">
      <div class="transport-buttons">
        <button id="btn-play-pause" class="btn btn-icon btn-transport" title={t(locale, 'playback.play')} data-state="stopped">
          <svg class="icon-play" viewBox="0 0 24 24" width="20" height="20"><polygon points="6,3 20,12 6,21" fill="currentColor"/></svg>
          <svg class="icon-pause" viewBox="0 0 24 24" width="20" height="20" hidden><rect x="5" y="3" width="4" height="18" fill="currentColor"/><rect x="15" y="3" width="4" height="18" fill="currentColor"/></svg>
        </button>
        <button id="btn-stop" class="btn btn-icon btn-transport" title={t(locale, 'playback.stop')} disabled>
          <svg viewBox="0 0 24 24" width="18" height="18"><rect x="4" y="4" width="16" height="16" rx="2" fill="currentColor"/></svg>
        </button>
      </div>
      <div class="control-params">
        <label class="control-label">
          {t(locale, 'playback.volume')}
          <input type="range" id="volume" min="0" max="1" step="0.01" value="0.8" />
        </label>
        <label class="control-label">
          {t(locale, 'playback.pan')}
          <input type="range" id="pan" min="-1" max="1" step="0.01" value="0" />
        </label>
        <label class="control-label">
          {t(locale, 'playback.speed')}
          <select id="speed">
            <option value="0.5">0.5x</option>
            <option value="0.75">0.75x</option>
            <option value="1" selected>1x</option>
            <option value="1.25">1.25x</option>
            <option value="1.5">1.5x</option>
            <option value="2">2x</option>
          </select>
        </label>
        <label class="control-label control-label-checkbox">
          <input type="checkbox" id="loop" />
          {t(locale, 'playback.loop')}
        </label>
      </div>
    </div>
  </section>
</div>

<script>
  import { getSharedPlayer, formatTime } from '../../demo/shared-player';
  import { initI18nStrings, drawWaveform, setTransportState, setupFileInputHandler, generateSynthBuffer } from '../../demo/demo-utils';
  import type { TransportElements } from '../../demo/demo-utils';
  import type { Playback, PeakPair } from 'waa';

  const $ = <T extends HTMLElement>(id: string) => document.getElementById(id) as T;

  const wrapper = document.querySelector('.demo-wrapper') as HTMLElement;
  const i18n = initI18nStrings(wrapper);

  const synthType = $<HTMLSelectElement>('synth-type');
  const synthFreq = $<HTMLInputElement>('synth-freq');
  const synthFreqVal = $('synth-freq-val');
  const synthDur = $<HTMLInputElement>('synth-dur');
  const synthDurVal = $('synth-dur-val');
  const btnGenerate = $<HTMLButtonElement>('btn-generate');

  const waveformSection = $('waveform-section');
  const waveformCanvas = $<HTMLCanvasElement>('waveform-canvas');
  const waveformCursor = $('waveform-cursor');
  const timeCurrent = $('time-current');
  const timeDuration = $('time-duration');

  const playbackSection = $('playback-section');
  const btnPlayPause = $<HTMLButtonElement>('btn-play-pause');
  const btnStop = $<HTMLButtonElement>('btn-stop');
  const transport: TransportElements = {
    btnPlayPause,
    btnStop,
    iconPlay: btnPlayPause.querySelector('.icon-play') as SVGElement,
    iconPause: btnPlayPause.querySelector('.icon-pause') as SVGElement,
  };
  const volumeInput = $<HTMLInputElement>('volume');
  const panInput = $<HTMLInputElement>('pan');
  const speedSelect = $<HTMLSelectElement>('speed');
  const loopCheckbox = $<HTMLInputElement>('loop');

  const player = getSharedPlayer();
  let gainNode: GainNode | null = null;
  let pannerNode: StereoPannerNode | null = null;
  let currentBuffer: AudioBuffer | null = null;
  let currentPlayback: Playback | null = null;
  let stopFrameLoop: (() => void) | null = null;
  let peaks: PeakPair[] = [];

  function initNodes() {
    if (!gainNode) {
      gainNode = player.createGain(0.8);
      pannerNode = player.createPanner(0);
      player.chain(gainNode, pannerNode!, player.ctx.destination);
    }
  }

  function loadAudio(buffer: AudioBuffer) {
    if (currentPlayback) { currentPlayback.dispose(); currentPlayback = null; }
    if (stopFrameLoop) { stopFrameLoop(); stopFrameLoop = null; }
    currentBuffer = buffer;
    peaks = player.extractPeakPairs(buffer, { resolution: 300 });
    waveformSection.hidden = false;
    playbackSection.hidden = false;
    drawWaveform(waveformCanvas, peaks);
    timeDuration.textContent = formatTime(buffer.duration);
    timeCurrent.textContent = formatTime(0);
    waveformCursor.style.left = '0%';
    setTransportState('stopped', transport, i18n);
  }

  synthFreq.addEventListener('input', () => {
    synthFreqVal.textContent = `${synthFreq.value} Hz`;
  });

  synthDur.addEventListener('input', () => {
    synthDurVal.textContent = `${Number(synthDur.value).toFixed(1)} s`;
  });

  btnGenerate.addEventListener('click', async () => {
    await player.ensureRunning();
    initNodes();
    const buffer = generateSynthBuffer(player, synthType.value, Number(synthFreq.value), Number(synthDur.value));
    loadAudio(buffer);
  });

  setupFileInputHandler(
    player, i18n,
    {
      fileInput: $<HTMLInputElement>('file-input'),
      fileLabel: $('file-label'),
      fileLabelText: $('file-label-text'),
      fileName: $('file-name'),
    },
    initNodes,
    loadAudio,
  );

  window.addEventListener('resize', () => {
    if (peaks.length > 0) drawWaveform(waveformCanvas, peaks);
  });

  waveformCanvas.parentElement!.addEventListener('click', (e) => {
    if (!currentPlayback || !currentBuffer) return;
    const rect = waveformCanvas.parentElement!.getBoundingClientRect();
    const ratio = (e.clientX - rect.left) / rect.width;
    currentPlayback.seek(ratio * currentBuffer.duration);
  });

  btnPlayPause.addEventListener('click', async () => {
    await player.ensureRunning();
    initNodes();
    if (!currentBuffer) return;
    if (currentPlayback && currentPlayback.getState() === 'playing') {
      currentPlayback.pause();
      setTransportState('paused', transport, i18n);
      return;
    }
    if (currentPlayback && currentPlayback.getState() === 'paused') {
      currentPlayback.resume();
      setTransportState('playing', transport, i18n);
      return;
    }
    if (currentPlayback) currentPlayback.dispose();
    if (stopFrameLoop) stopFrameLoop();

    currentPlayback = player.play(currentBuffer, {
      through: [gainNode!],
      loop: loopCheckbox.checked,
      playbackRate: Number(speedSelect.value),
    });
    setTransportState('playing', transport, i18n);

    stopFrameLoop = player.onFrame(currentPlayback, (snapshot) => {
      waveformCursor.style.left = `${snapshot.progress * 100}%`;
      timeCurrent.textContent = formatTime(snapshot.position);
      if (snapshot.state === 'playing') setTransportState('playing', transport, i18n);
      else if (snapshot.state === 'paused') setTransportState('paused', transport, i18n);
    });

    currentPlayback.on('ended', () => {
      setTransportState('stopped', transport, i18n);
      waveformCursor.style.left = '0%';
      timeCurrent.textContent = formatTime(0);
    });
  });

  btnStop.addEventListener('click', () => {
    if (currentPlayback) {
      currentPlayback.stop();
      setTransportState('stopped', transport, i18n);
      waveformCursor.style.left = '0%';
      timeCurrent.textContent = formatTime(0);
    }
  });

  volumeInput.addEventListener('input', () => {
    if (gainNode) gainNode.gain.value = Number(volumeInput.value);
  });

  panInput.addEventListener('input', () => {
    if (pannerNode) pannerNode.pan.value = Number(panInput.value);
  });

  speedSelect.addEventListener('change', () => {
    if (currentPlayback) currentPlayback.setPlaybackRate(Number(speedSelect.value));
  });

  loopCheckbox.addEventListener('change', () => {
    if (currentPlayback) currentPlayback.setLoop(loopCheckbox.checked);
  });
</script>

<style is:global>
  @import '../../demo/style.css';
</style>
