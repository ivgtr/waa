---
import { t } from '../../i18n/translations';
import type { Locale } from '../../i18n/translations';

interface Props {
  locale: Locale;
}

const { locale } = Astro.props;
---

<div
  class="demo-wrapper not-content"
  id="viz-demo"
  data-i18n-pause={t(locale, 'playback.pause')}
  data-i18n-play={t(locale, 'playback.play')}
  data-i18n-loading={t(locale, 'source.loading')}
  data-i18n-load-failed={t(locale, 'source.load-failed')}
  data-i18n-load-file={t(locale, 'source.load-file')}
>
  <!-- Sound Source -->
  <section class="card">
    <h2>{t(locale, 'source.title')}</h2>
    <div class="source-controls">
      <div class="synth-controls">
        <div class="synth-params">
          <label class="synth-label">
            <span class="label-text">{t(locale, 'source.type')}</span>
            <select id="viz-synth-type">
              <option value="sine">{t(locale, 'source.sine')}</option>
              <option value="noise">{t(locale, 'source.noise')}</option>
              <option value="click">{t(locale, 'source.click')}</option>
            </select>
          </label>
          <label class="synth-label">
            <span class="label-text">{t(locale, 'source.frequency')}</span>
            <input type="range" id="viz-synth-freq" min="50" max="2000" value="440" />
            <span id="viz-synth-freq-val" class="range-value">440 Hz</span>
          </label>
          <label class="synth-label">
            <span class="label-text">{t(locale, 'source.duration')}</span>
            <input type="range" id="viz-synth-dur" min="1" max="10" step="0.5" value="3" />
            <span id="viz-synth-dur-val" class="range-value">3.0 s</span>
          </label>
        </div>
        <button id="viz-btn-generate" class="btn btn-primary">{t(locale, 'source.generate')}</button>
      </div>
      <div class="divider">{t(locale, 'source.or')}</div>
      <div class="file-controls">
        <label class="btn btn-secondary file-label" id="viz-file-label">
          <svg class="file-icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          <span id="viz-file-label-text">{t(locale, 'source.load-file')}</span>
          <input type="file" id="viz-file-input" accept="audio/*" hidden />
        </label>
        <span id="viz-file-name" class="file-name"></span>
      </div>
    </div>
  </section>

  <!-- Waveform -->
  <section class="card" id="viz-waveform-section" hidden>
    <h2>{t(locale, 'waveform.title')}</h2>
    <div class="control-params" style="margin-bottom: 0.75rem;">
      <label class="control-label">
        {t(locale, 'demo.viz.resolution')}
        <input type="range" id="viz-resolution" min="50" max="500" step="10" value="300" />
        <span id="viz-resolution-val" class="range-value">300</span>
      </label>
    </div>
    <div class="waveform-container">
      <canvas id="viz-waveform-canvas"></canvas>
      <div id="viz-waveform-cursor" class="waveform-cursor"></div>
    </div>
  </section>

  <!-- Frequency Visualizer -->
  <section class="card" id="viz-freq-section" hidden>
    <h2>{t(locale, 'visualizer.title')}</h2>
    <div class="transport-buttons" style="margin-bottom: 0.75rem;">
      <button id="viz-btn-play" class="btn btn-icon btn-transport" data-state="stopped">
        <svg class="icon-play" viewBox="0 0 24 24" width="20" height="20"><polygon points="6,3 20,12 6,21" fill="currentColor"/></svg>
        <svg class="icon-pause" viewBox="0 0 24 24" width="20" height="20" hidden><rect x="5" y="3" width="4" height="18" fill="currentColor"/><rect x="15" y="3" width="4" height="18" fill="currentColor"/></svg>
      </button>
      <button id="viz-btn-stop" class="btn btn-icon btn-transport" disabled>
        <svg viewBox="0 0 24 24" width="18" height="18"><rect x="4" y="4" width="16" height="16" rx="2" fill="currentColor"/></svg>
      </button>
    </div>
    <canvas id="viz-freq-canvas"></canvas>
  </section>
</div>

<script>
  import { getSharedPlayer } from '../../demo/shared-player';
  import { initI18nStrings, drawWaveform, setTransportState, setupFileInputHandler, generateSynthBuffer } from '../../demo/demo-utils';
  import type { TransportElements } from '../../demo/demo-utils';
  import type { Playback, PeakPair } from 'waa';

  const $ = <T extends HTMLElement>(id: string) => document.getElementById(id) as T;

  const wrapper = document.getElementById('viz-demo') as HTMLElement;
  const i18n = initI18nStrings(wrapper);

  const synthType = $<HTMLSelectElement>('viz-synth-type');
  const synthFreq = $<HTMLInputElement>('viz-synth-freq');
  const synthFreqVal = $('viz-synth-freq-val');
  const synthDur = $<HTMLInputElement>('viz-synth-dur');
  const synthDurVal = $('viz-synth-dur-val');
  const btnGenerate = $<HTMLButtonElement>('viz-btn-generate');

  const waveformSection = $('viz-waveform-section');
  const waveformCanvas = $<HTMLCanvasElement>('viz-waveform-canvas');
  const waveformCursor = $('viz-waveform-cursor');
  const resolutionInput = $<HTMLInputElement>('viz-resolution');
  const resolutionVal = $('viz-resolution-val');

  const freqSection = $('viz-freq-section');
  const freqCanvas = $<HTMLCanvasElement>('viz-freq-canvas');

  const btnPlay = $<HTMLButtonElement>('viz-btn-play');
  const btnStop = $<HTMLButtonElement>('viz-btn-stop');
  const transport: TransportElements = {
    btnPlayPause: btnPlay,
    btnStop,
    iconPlay: btnPlay.querySelector('.icon-play') as SVGElement,
    iconPause: btnPlay.querySelector('.icon-pause') as SVGElement,
  };

  const player = getSharedPlayer();
  let gainNode: GainNode | null = null;
  let analyserNode: AnalyserNode | null = null;
  let currentBuffer: AudioBuffer | null = null;
  let currentPlayback: Playback | null = null;
  let stopFrameLoop: (() => void) | null = null;
  let peaks: PeakPair[] = [];

  function initNodes() {
    if (!gainNode) {
      gainNode = player.createGain(0.8);
      analyserNode = player.createAnalyser({ fftSize: 256 });
      player.chain(gainNode, analyserNode!, player.ctx.destination);
    }
  }

  function loadAudio(buffer: AudioBuffer) {
    if (currentPlayback) { currentPlayback.dispose(); currentPlayback = null; }
    if (stopFrameLoop) { stopFrameLoop(); stopFrameLoop = null; }
    currentBuffer = buffer;
    peaks = player.extractPeakPairs(buffer, { resolution: Number(resolutionInput.value) });
    waveformSection.hidden = false;
    freqSection.hidden = false;
    drawWaveform(waveformCanvas, peaks);
    resizeFreqCanvas();
    setTransportState('stopped', transport, i18n);
  }

  synthFreq.addEventListener('input', () => {
    synthFreqVal.textContent = `${synthFreq.value} Hz`;
  });

  synthDur.addEventListener('input', () => {
    synthDurVal.textContent = `${Number(synthDur.value).toFixed(1)} s`;
  });

  resolutionInput.addEventListener('input', () => {
    const res = Number(resolutionInput.value);
    resolutionVal.textContent = `${res}`;
    if (currentBuffer) {
      peaks = player.extractPeakPairs(currentBuffer, { resolution: res });
      drawWaveform(waveformCanvas, peaks);
    }
  });

  btnGenerate.addEventListener('click', async () => {
    await player.ensureRunning();
    initNodes();
    const buffer = generateSynthBuffer(player, synthType.value, Number(synthFreq.value), Number(synthDur.value));
    loadAudio(buffer);
  });

  setupFileInputHandler(
    player, i18n,
    {
      fileInput: $<HTMLInputElement>('viz-file-input'),
      fileLabel: $('viz-file-label'),
      fileLabelText: $('viz-file-label-text'),
      fileName: $('viz-file-name'),
    },
    initNodes,
    loadAudio,
  );

  function resizeFreqCanvas() {
    const rect = freqCanvas.parentElement!.getBoundingClientRect();
    freqCanvas.width = rect.width * devicePixelRatio;
    freqCanvas.height = 120 * devicePixelRatio;
  }

  function drawVisualizer() {
    if (!analyserNode) return;
    const c = freqCanvas.getContext('2d')!;
    const rect = freqCanvas.parentElement!.getBoundingClientRect();
    const w = rect.width, h = 120;
    if (freqCanvas.width !== w * devicePixelRatio) {
      freqCanvas.width = w * devicePixelRatio;
      freqCanvas.height = h * devicePixelRatio;
    }
    c.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
    const data = player.getFrequencyDataByte(analyserNode);
    const barWidth = w / data.length;
    c.clearRect(0, 0, w, h);
    for (let i = 0; i < data.length; i++) {
      const value = data[i]! / 255;
      const barHeight = value * h;
      const hue = 240 + value * 60;
      c.fillStyle = `hsla(${hue}, 70%, 60%, 0.8)`;
      c.fillRect(i * barWidth, h - barHeight, barWidth - 1, barHeight);
    }
  }

  window.addEventListener('resize', () => {
    if (peaks.length > 0) drawWaveform(waveformCanvas, peaks);
    resizeFreqCanvas();
  });

  btnPlay.addEventListener('click', async () => {
    await player.ensureRunning();
    initNodes();
    if (!currentBuffer) return;
    if (currentPlayback && currentPlayback.getState() === 'playing') {
      currentPlayback.pause();
      setTransportState('paused', transport, i18n);
      return;
    }
    if (currentPlayback && currentPlayback.getState() === 'paused') {
      currentPlayback.resume();
      setTransportState('playing', transport, i18n);
      return;
    }
    if (currentPlayback) currentPlayback.dispose();
    if (stopFrameLoop) stopFrameLoop();

    currentPlayback = player.play(currentBuffer, {
      through: [gainNode!],
      loop: true,
    });
    setTransportState('playing', transport, i18n);

    stopFrameLoop = player.onFrame(currentPlayback, (snapshot) => {
      waveformCursor.style.left = `${snapshot.progress * 100}%`;
      if (analyserNode) drawVisualizer();
      if (snapshot.state === 'playing') setTransportState('playing', transport, i18n);
      else if (snapshot.state === 'paused') setTransportState('paused', transport, i18n);
    });

    currentPlayback.on('ended', () => {
      setTransportState('stopped', transport, i18n);
      waveformCursor.style.left = '0%';
    });
  });

  btnStop.addEventListener('click', () => {
    if (currentPlayback) {
      currentPlayback.stop();
      setTransportState('stopped', transport, i18n);
      waveformCursor.style.left = '0%';
    }
  });
</script>

<style>
  @import '../../demo/style.css';

  #viz-freq-canvas {
    width: 100%;
    height: 120px;
    display: block;
    background: var(--bg, #0f1117);
    border-radius: 8px;
  }
</style>
